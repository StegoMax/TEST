<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Dashboard Pro - Stock & Crypto Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }
        body {
            min-height: 100vh;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: #0a0a0c;
        }
        .glass {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
        }
        .progress-bar-container {
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #3b82f6);
            transition: width 1s ease-in-out;
        }
        .hidden-content {
            filter: blur(12px);
            pointer-events: none;
            user-select: none;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 115%;
            width: 240px;
            z-index: 10000;
        }
        .dropdown-menu.active {
            display: block;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading-pulse { animation: pulse-soft 2s infinite; }

        .asset-mix-bar {
            height: 4px;
            border-radius: 2px;
            background: rgba(255,255,255,0.1);
            margin-top: 8px;
        }
    </style>
</head>
<body class="text-white font-sans antialiased p-4 md:p-8">

    <!-- APLICACIÓN PRINCIPAL -->
    <main id="appContent" class="max-w-6xl mx-auto space-y-6 opacity-0 transition-opacity duration-700">
        
        <!-- CABECERA Y LÍNEA DE TIEMPO -->
        <header class="glass p-6 relative z-[50]">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                    <h1 id="greeting" class="text-3xl font-bold">¡Hola!</h1>
                    <div class="flex items-center gap-3 mt-1">
                        <p id="currentDate" class="text-white/80 text-sm"></p>
                        <span id="weekNumber" class="text-[10px] bg-white/10 px-2 py-0.5 rounded border border-white/5 font-mono uppercase tracking-widest text-white/60">Semana 0</span>
                    </div>
                </div>
                
                <div class="mt-4 md:mt-0 flex flex-wrap gap-2 relative">
                    <button onclick="fetchAllPrices()" class="text-xs bg-white/10 p-2 px-3 rounded hover:bg-white/20 transition-all border border-white/5" title="Actualizar Precios">
                        <i id="syncIcon" class="fas fa-sync-alt"></i>
                    </button>
                    
                    <button onclick="exportData()" class="text-xs bg-blue-600/30 p-2 px-3 rounded hover:bg-blue-600/50 transition-all border border-blue-500/20" title="Guardar Copia de Seguridad">
                        <i class="fas fa-save mr-1"></i>
                    </button>

                    <button onclick="document.getElementById('importFile').click()" class="text-xs bg-emerald-600/30 p-2 px-3 rounded hover:bg-emerald-600/50 transition-all border border-emerald-500/20" title="Cargar Datos">
                        <i class="fas fa-folder-open mr-1"></i>
                    </button>
                    <input type="file" id="importFile" class="hidden" onchange="importData(event)">

                    <button onclick="toggleSettings()" class="text-xs bg-white/10 p-2 px-3 rounded hover:bg-white/20 transition-all border border-white/5">
                        <i class="fas fa-cog mr-1"></i>
                    </button>
                    
                    <div id="settingsDropdown" class="dropdown-menu glass p-5 shadow-2xl border-white/30 bg-black/80">
                        <div class="mb-4">
                            <p class="text-[10px] uppercase font-bold text-white/40 mb-2 tracking-widest">Mensaje</p>
                            <input type="text" id="userNameEdit" oninput="updateName(this.value)" class="w-full bg-black/40 border border-white/10 text-white text-xs p-2 rounded focus:border-blue-500 outline-none" placeholder="Tu mensaje...">
                        </div>

                        <div class="mb-4">
                            <p class="text-[10px] uppercase font-bold text-white/40 mb-2 tracking-widest">Divisa Principal</p>
                            <select onchange="updateCurrency(this.value)" id="currencySelect" class="w-full bg-black/40 border border-white/10 text-white text-xs p-2 rounded outline-none">
                                <option value="usd">USD - Dólar</option>
                                <option value="eur">EUR - Euro</option>
                                <option value="gbp">GBP - Libra</option>
                                <option value="mxn">MXN - Peso</option>
                                <option value="jpy">JPY - Yen</option>
                            </select>
                        </div>

                        <div>
                            <p class="text-[10px] uppercase font-bold text-white/40 mb-2 tracking-widest">Personalización</p>
                            <select onchange="updateBgSelection(this.value)" id="quickBgType" class="w-full bg-black/40 border border-white/10 text-white text-xs p-2 rounded mb-3 outline-none">
                                <option value="random">Fondo Aleatorio</option>
                                <option value="solid">Color Sólido</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-2">
                <div class="flex justify-between text-xs">
                    <span id="timelineLabel" class="uppercase tracking-wider opacity-60">Progreso del Año</span>
                    <span id="yearPercent" class="font-mono font-bold">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div id="yearProgressBar" class="progress-fill" style="width: 0%"></div>
                </div>
                <p id="daysRemaining" class="text-[10px] text-center text-white/40 pt-1 uppercase tracking-tighter"></p>
            </div>
        </header>

        <!-- SECCIÓN PRODUCTIVIDAD -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10">
            <section class="glass p-6 flex flex-col h-[400px]">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2 uppercase text-xs tracking-widest opacity-80">
                    <i class="fas fa-list-ul text-green-400"></i> Objetivos Diarios
                </h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newTaskInput" class="flex-1 bg-white/5 border border-white/10 rounded p-2 focus:outline-none text-sm" placeholder="Nueva meta...">
                    <button onclick="addTask()" class="bg-white/10 hover:bg-white/20 px-4 rounded text-sm transition-all border border-white/10">Añadir</button>
                </div>
                <ul id="taskList" class="flex-1 overflow-y-auto space-y-2 pr-2 text-sm"></ul>
            </section>

            <section class="glass p-6 flex flex-col h-[400px]">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2 uppercase text-xs tracking-widest opacity-80">
                    <i class="fas fa-brain text-blue-400"></i> Notas Rápidas
                </h2>
                <textarea id="notesArea" oninput="saveNotes()" class="flex-1 bg-white/5 border border-white/10 rounded p-4 focus:outline-none resize-none text-sm leading-relaxed" placeholder="Vuelca tus pensamientos aquí..."></textarea>
            </section>
        </div>

        <!-- PANEL DE INVERSIONES -->
        <section class="glass p-6 relative z-0">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-bold">Cartera <span class="text-[10px] opacity-40 font-normal ml-2 uppercase tracking-widest">(Precios Yahoo/Coingecko)</span></h2>
                    <button onclick="togglePrivacy()" id="privacyBtn" class="bg-white/10 p-2 rounded-full hover:bg-white/20 transition-all">
                        <i id="privacyIcon" class="fas fa-eye-slash"></i>
                    </button>
                </div>
                <button onclick="showInversionModal()" class="bg-blue-600/60 hover:bg-blue-600 px-4 py-2 rounded text-[10px] font-bold transition-all uppercase tracking-widest">Gestionar</button>
            </div>
            
            <div id="inversionsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            
            <div class="mt-6 pt-6 border-t border-white/5 flex flex-col sm:flex-row justify-between items-end gap-4">
                <div class="space-y-1">
                    <p class="text-[10px] text-white/40 uppercase tracking-widest">Valor Total de Cartera</p>
                    <div id="totalPortfolioValue" class="text-3xl font-bold font-mono">$0.00</div>
                    <p id="portfolioStats" class="text-[10px] text-blue-400/80 uppercase font-bold"></p>
                </div>
                <div class="flex items-center gap-2">
                    <div id="statusIndicator" class="w-2 h-2 rounded-full bg-green-500 loading-pulse"></div>
                    <p id="statusText" class="text-[9px] text-white/40 uppercase tracking-[0.2em]">Sincronización Activa</p>
                </div>
            </div>
        </section>
    </main>

    <!-- MODAL -->
    <div id="invModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[110]">
        <div class="glass p-8 max-w-xl w-full border border-white/20 shadow-2xl">
            <h2 class="text-2xl font-bold mb-2">Configurar Activos</h2>
            <p class="text-[10px] text-white/40 uppercase mb-4 tracking-tighter">Cripto: id coingecko (ej: bitcoin) | Acción: Ticker (ej: AAPL, TSLA, IDR.MC)</p>
            <div id="invEditorList" class="max-h-60 overflow-y-auto space-y-2 mb-6 pr-2 border-b border-white/10 pb-4"></div>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 mb-4">
                <select id="newInvType" class="p-2 bg-black/40 border border-white/20 rounded text-xs text-white">
                    <option value="crypto">Cripto</option>
                    <option value="stock">Acción</option>
                </select>
                <input type="text" id="newInvId" placeholder="ID / Ticker" class="p-2 bg-black/40 border border-white/20 rounded text-xs uppercase text-white">
                <input type="text" id="newInvLabel" placeholder="Alias" class="p-2 bg-black/40 border border-white/20 rounded text-xs text-white">
                <input type="number" id="newInvQty" placeholder="Cant." class="p-2 bg-black/40 border border-white/10 rounded text-xs text-white" step="any">
            </div>
            <div class="flex gap-2">
                <button onclick="addNewInversion()" class="flex-1 bg-blue-600 hover:bg-blue-700 p-2 rounded font-bold text-xs transition-all uppercase">Añadir Activo</button>
                <button onclick="hideInversionModal()" class="flex-1 bg-white/10 p-2 rounded text-xs hover:bg-white/20 transition-all uppercase">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = "mi_dashboard_final_v3";
        
        let state = {
            name: "¡Hola!",
            bgType: "random",
            bgValue: "",
            privacyMode: false,
            currency: "eur",
            inversions: [
                { id: "bitcoin", type: "crypto", label: "Bitcoin", quantity: 0.1, currentPrice: 0, change24h: 0 },
                { id: "IDR.MC", type: "stock", label: "Indra", quantity: 100, currentPrice: 0, change24h: 0 },
                { id: "AAPL", type: "stock", label: "Apple", quantity: 5, currentPrice: 0, change24h: 0 }
            ],
            tasks: [],
            notes: ""
        };

        function formatValue(value) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: (state.currency || 'eur').toUpperCase(),
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try { 
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                } catch(e) { console.warn("Iniciando con estado por defecto."); }
            }
            initApp();
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        // --- Lógica de Mercado ---

        async function fetchPriceWithProxies(ticker) {
            let cleanTicker = ticker.trim().replace(/\s+/g, '.').toUpperCase();
            
            // Yahoo espera .MC para la Bolsa de Madrid
            if (cleanTicker.endsWith('.BME')) cleanTicker = cleanTicker.replace('.BME', '.MC');

            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${cleanTicker}?interval=1m&range=1d`;
            
            const proxies = [
                (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`
            ];

            for (let getProxy of proxies) {
                try {
                    const response = await fetch(getProxy(yahooUrl), { method: 'GET', timeout: 5000 });
                    if (!response.ok) continue;
                    
                    const data = await response.json();
                    let json = data;
                    
                    if (typeof data.contents === 'string') {
                        json = JSON.parse(data.contents);
                    } else if (data.contents) {
                        json = data.contents;
                    }

                    if (json && json.chart && json.chart.result && json.chart.result[0]) {
                        const meta = json.chart.result[0].meta;
                        
                        // Si es .MC forzamos EUR si no viene divisa
                        let detectedCurrency = meta.currency ? meta.currency.toUpperCase() : (cleanTicker.endsWith('.MC') ? 'EUR' : 'USD');
                        
                        return {
                            price: meta.regularMarketPrice,
                            currency: detectedCurrency,
                            change: ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose) * 100
                        };
                    }
                } catch (e) {
                    continue; 
                }
            }
            return null;
        }

        async function fetchAllPrices() {
            const syncIcon = document.getElementById('syncIcon');
            const statusIndicator = document.getElementById('statusIndicator');
            
            if (syncIcon) syncIcon.classList.add('fa-spin');
            if (statusIndicator) statusIndicator.className = "w-2 h-2 rounded-full bg-yellow-500 loading-pulse";

            const targetCurrency = (state.currency || 'eur').toLowerCase();
            
            // Diccionario para almacenar las tasas de cambio base
            // Fallbacks realistas por si falla la API de FX
            let exchangeRates = { 
                "USD": targetCurrency === 'eur' ? 0.92 : 1, 
                "EUR": targetCurrency === 'usd' ? 1.09 : 1,
                "GBP": targetCurrency === 'eur' ? 1.17 : 1.27
            };

            // Intentar actualizar tasas de cambio con CoinGecko
            try {
                const fxRes = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=tether,euro,british-pound-sterling&vs_currencies=${targetCurrency}`);
                if (fxRes.ok) {
                    const fxData = await fxRes.json();
                    if (fxData['tether']) exchangeRates['USD'] = fxData['tether'][targetCurrency];
                    if (fxData['euro']) exchangeRates['EUR'] = fxData['euro'][targetCurrency];
                    if (fxData['british-pound-sterling']) exchangeRates['GBP'] = fxData['british-pound-sterling'][targetCurrency];
                }
            } catch (e) { 
                console.warn("Usando tasas de cambio estáticas de seguridad."); 
            }

            // 1. Criptos
            const cryptos = state.inversions.filter(i => i.type === 'crypto');
            if (cryptos.length > 0) {
                try {
                    const ids = cryptos.map(c => c.id).join(',');
                    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=${targetCurrency}&include_24hr_change=true`;
                    const res = await fetch(url);
                    if (res.ok) {
                        const data = await res.json();
                        state.inversions = state.inversions.map(inv => {
                            if (inv.type === 'crypto' && data[inv.id]) {
                                return { 
                                    ...inv, 
                                    currentPrice: data[inv.id][targetCurrency], 
                                    change24h: data[inv.id][`${targetCurrency}_24h_change`] || 0 
                                };
                            }
                            return inv;
                        });
                    }
                } catch (e) { console.warn("Error Cripto API"); }
            }

            // 2. Acciones
            for (let i = 0; i < state.inversions.length; i++) {
                const inv = state.inversions[i];
                if (inv.type === 'stock') {
                    const result = await fetchPriceWithProxies(inv.id);
                    if (result) {
                        let originalCurrency = result.currency;
                        let rawPrice = result.price;

                        // CORRECCIÓN PARA GBp (Centavos de libra)
                        if (originalCurrency === 'GBX' || originalCurrency === 'GBP' && rawPrice > 1000 && inv.id.includes('.L')) {
                             rawPrice = rawPrice / 100;
                             originalCurrency = 'GBP';
                        }

                        const targetCurrencyUpper = targetCurrency.toUpperCase();
                        let finalPrice = rawPrice;
                        
                        // Conversión de divisa
                        if (originalCurrency !== targetCurrencyUpper) {
                            // Si la moneda del activo es USD y queremos EUR: precio * 0.92
                            // Si la moneda del activo es EUR y queremos USD: precio * 1.09
                            const rate = exchangeRates[originalCurrency];
                            if (rate) {
                                finalPrice = rawPrice * rate;
                            }
                        }
                        
                        state.inversions[i].currentPrice = finalPrice;
                        state.inversions[i].change24h = result.change;
                    }
                }
            }

            if (syncIcon) syncIcon.classList.remove('fa-spin');
            if (statusIndicator) statusIndicator.className = "w-2 h-2 rounded-full bg-green-500 loading-pulse";
            
            renderInversions();
            saveState();
        }

        // --- UI y Renderizado ---

        function renderInversions() {
            const grid = document.getElementById('inversionsGrid');
            grid.innerHTML = "";
            let totalPortfolio = 0;
            
            state.inversions.forEach(inv => {
                totalPortfolio += (inv.currentPrice * inv.quantity);
            });

            state.inversions.forEach(inv => {
                const totalValue = inv.currentPrice * inv.quantity;
                const allocation = totalPortfolio > 0 ? (totalValue / totalPortfolio * 100).toFixed(1) : 0;
                const isPositive = inv.change24h >= 0;
                
                const card = document.createElement('div');
                card.className = "glass p-5 border border-white/5 flex flex-col justify-between hover:bg-white/5 transition-all group";
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[8px] bg-white/10 px-1.5 py-0.5 rounded text-white/60 font-bold uppercase">${inv.type}</span>
                                <p class="text-[11px] text-white font-bold uppercase tracking-wider">${inv.label}</p>
                            </div>
                            <p class="text-[10px] text-white/30 font-mono">${inv.quantity.toLocaleString()} UNID.</p>
                        </div>
                        <div class="text-right">
                            <div class="${isPositive ? 'text-green-400' : 'text-red-400'} text-[11px] font-bold flex items-center gap-1 justify-end">
                                <i class="fas ${isPositive ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down'} text-[9px]"></i>
                                ${Math.abs(inv.change24h || 0).toFixed(2)}%
                            </div>
                            <div class="text-[9px] text-white/20 uppercase font-bold mt-1">${allocation}% MIX</div>
                        </div>
                    </div>
                    
                    <div class="mt-5 ${state.privacyMode ? 'hidden-content' : ''}">
                        <div class="flex justify-between items-end">
                            <div>
                                <h3 class="text-2xl font-bold font-mono tracking-tight">${formatValue(totalValue)}</h3>
                                <p class="text-[9px] text-white/30 uppercase mt-1">Precio: ${formatValue(inv.currentPrice)}</p>
                            </div>
                        </div>
                        <div class="asset-mix-bar overflow-hidden">
                            <div class="h-full bg-blue-500/50" style="width: ${allocation}%"></div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            const totalEl = document.getElementById('totalPortfolioValue');
            totalEl.innerText = formatValue(totalPortfolio);
            if (state.privacyMode) totalEl.classList.add('hidden-content');
            else totalEl.classList.remove('hidden-content');
            
            document.getElementById('portfolioStats').innerText = `${state.inversions.length} ACTIVOS EN CARTERA`;
        }

        // --- Funcionalidades Dashboard ---

        function updateName(val) { state.name = val || "¡Hola!"; document.getElementById('greeting').innerText = state.name; saveState(); }
        
        async function updateCurrency(val) { 
            state.currency = val; 
            saveState(); 
            await fetchAllPrices(); 
        }

        function updateBgSelection(val) { state.bgType = val; updateBackground(); saveState(); }
        function toggleSettings() { document.getElementById('settingsDropdown').classList.toggle('active'); }
        function togglePrivacy() { state.privacyMode = !state.privacyMode; renderInversions(); saveState(); }
        function showInversionModal() { document.getElementById('invModal').classList.remove('hidden'); renderInvEditor(); }
        function hideInversionModal() { document.getElementById('invModal').classList.add('hidden'); }
        
        function updateBackground() {
            if (state.bgType === 'random') {
                document.body.style.backgroundImage = `url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?auto=format&fit=crop&q=80&w=1920')`;
                document.body.style.backgroundColor = "transparent";
            } else {
                document.body.style.backgroundImage = "none";
                document.body.style.backgroundColor = "#0a0a0c";
            }
        }

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDate').innerText = now.toLocaleDateString('es-ES', { weekday: 'long', month: 'long', day: 'numeric' });
            const start = new Date(now.getFullYear(), 0, 1);
            const week = Math.ceil((((now - start) / 86400000) + start.getDay() + 1) / 7);
            document.getElementById('weekNumber').innerText = `Semana ${week}`;
        }

        function updateTimeline() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 1);
            const end = new Date(now.getFullYear(), 11, 31);
            const pct = (((now - start) / (end - start)) * 100).toFixed(0);
            document.getElementById('yearProgressBar').style.width = `${pct}%`;
            document.getElementById('yearPercent').innerText = `${pct}%`;
            document.getElementById('daysRemaining').innerText = `${Math.ceil((end - now) / 86400000)} días para terminar el año`;
        }

        function renderTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = "";
            state.tasks.forEach(t => {
                const li = document.createElement('li');
                li.className = "flex items-center justify-between bg-white/5 p-3 rounded border border-white/5 hover:bg-white/10 transition-all group";
                li.innerHTML = `
                    <div class="cursor-pointer flex items-center" onclick="toggleTask(${t.id})">
                        <i class="fa-regular ${t.done ? 'fa-check-circle text-green-400' : 'fa-circle text-white/20'} mr-3"></i>
                        <span class="${t.done ? 'line-through opacity-30' : ''}">${t.text}</span>
                    </div>
                    <button onclick="deleteTask(${t.id})" class="text-white/0 group-hover:text-white/20 hover:text-red-400 transition-all p-2"><i class="fas fa-times text-xs"></i></button>`;
                list.appendChild(li);
            });
        }

        function addTask() {
            const input = document.getElementById('newTaskInput');
            if (!input.value.trim()) return;
            state.tasks.push({ id: Date.now(), text: input.value, done: false });
            input.value = ""; renderTasks(); saveState();
        }

        function toggleTask(id) { 
            const t = state.tasks.find(x => x.id === id); 
            if (t) t.done = !t.done; 
            renderTasks(); saveState(); 
        }

        function deleteTask(id) { state.tasks = state.tasks.filter(x => x.id !== id); renderTasks(); saveState(); }
        function saveNotes() { state.notes = document.getElementById('notesArea').value; saveState(); }

        function renderInvEditor() {
            const list = document.getElementById('invEditorList');
            list.innerHTML = "";
            state.inversions.forEach((inv, idx) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white/5 p-3 rounded border border-white/5";
                div.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-blue-300 text-[10px] uppercase">${inv.label} (${inv.id})</span>
                        <span class="text-[9px] text-white/40">${inv.quantity} unidades</span>
                    </div>
                    <button onclick="removeInversion(${idx})" class="text-white/20 hover:text-red-400 transition-colors p-2"><i class="fas fa-trash-alt"></i></button>`;
                list.appendChild(div);
            });
        }

        async function addNewInversion() {
            const type = document.getElementById('newInvType').value;
            const id = document.getElementById('newInvId').value.trim();
            const label = document.getElementById('newInvLabel').value.trim();
            const qty = parseFloat(document.getElementById('newInvQty').value);
            
            if (id && !isNaN(qty)) {
                state.inversions.push({ id, type, label: label || id, quantity: qty, currentPrice: 0, change24h: 0 });
                document.getElementById('newInvId').value = "";
                document.getElementById('newInvQty').value = "";
                document.getElementById('newInvLabel').value = "";
                renderInvEditor(); 
                await fetchAllPrices();
            }
        }

        function removeInversion(idx) { state.inversions.splice(idx, 1); renderInvEditor(); renderInversions(); saveState(); }

        function exportData() {
            const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup_dashboard.json'; a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => { 
                try { 
                    const imported = JSON.parse(ev.target.result); 
                    state = { ...state, ...imported };
                    saveState(); 
                    location.reload(); 
                } catch(err) { console.error("Error importando archivo."); }
            };
            reader.readAsText(file);
        }

        async function initApp() {
            document.getElementById('appContent').classList.remove('opacity-0');
            document.getElementById('greeting').innerText = state.name;
            document.getElementById('userNameEdit').value = state.name === "¡Hola!" ? "" : state.name;
            document.getElementById('currencySelect').value = state.currency || "eur";
            
            updateBackground();
            updateDateTime();
            updateTimeline();
            renderTasks();
            document.getElementById('notesArea').value = state.notes || "";
            
            await fetchAllPrices(); 
            setInterval(fetchAllPrices, 300000); 
            setInterval(updateDateTime, 30000);
        }

        window.onload = loadState;
        
        window.onclick = function(event) {
            if (!event.target.closest('.relative')) {
                const dropdown = document.getElementById('settingsDropdown');
                if (dropdown && dropdown.classList.contains('active')) {
                    dropdown.classList.remove('active');
                }
            }
        }
    </script>
</body>
</html>
